{% load static %}

<style>
    {% block map_css %}
        {% if map_width and map_height %}
            #{{ id_map }} {
                width: {{ map_width }};
                height: {{ map_height }};
            }
        {% endif %}
        {% if not display_raw %}
            {# id_geom_map #}
            #{{ id }} {
                display: none;
            }
        {% endif %}
    {% endblock map_css %}
</style>

{#{% if not target_map %}#}
{#    {% block map %}#}
{#        <div id="{{ id_map }}" class="maplibre-map"></div>#}
{#    {% endblock map %}#}
{#{% endif %}#}

 {% block map %}
        <div id="{{ id_map }}" class="maplibre-map"></div>
 {% endblock map %}


<script type="text/javascript">
    {#function {{ id_map_callback }}(map) {#}
    {#    // Configuration du champ géométrique#}
    {#    const fieldConfig = {#}
    {#        fieldid: '{{ id }}',#}
    {#        modifiable: {{ modifiable|yesno:"true,false" }},#}
    {#        geom_type: '{{ geom_type }}',#}
    {#        srid: {{ map_srid }},#}
    {#        store_class: MaplibreFieldStore#}
    {#    };#}
    {##}
    {#    // Initialisation du champ géométrique MapLibre#}
    {#    (new MaplibreGeometryField(fieldConfig)).addTo(map);#}
    {#    {% block callback %}{% endblock callback %}#}
    {# } #}

{#    {% if target_map %}#}
{#        // Réutilisation d'une carte MapLibre existante#}
{#        document.addEventListener('DOMContentLoaded', function() {#}
{#            // Chercher la carte cible par son ID#}
{#            const targetMapElement = document.getElementById('{{ target_map }}-map');#}
{##}
{#            if (targetMapElement && targetMapElement._maplibreMap) {#}
{#                // Récupérer l'instance MapLibre existante#}
{#                const targetMap = targetMapElement._maplibreMap;#}
{##}
{#                // Attendre que la carte cible soit prête si nécessaire#}
{#                if (targetMap.loaded()) {#}
{#                    {{ id_map_callback }}(targetMap);#}
{#                } else {#}
{#                    targetMap.on('load', function() {#}
{#                        {{ id_map_callback }}(targetMap);#}
{#                    });#}
{#                }#}
{#            } else {#}
{#                console.error('Carte cible non trouvée pour target_map: {{ target_map }}');#}
{#            }#}
{#        });#}
{#    {% else %}#}
{#        // Initialisation d'une nouvelle carte MapLibre#}
{#        document.addEventListener('DOMContentLoaded', function() {#}
{#            const mapId = '{{ id_map }}';#}
{##}
{#            const {BOUNDS, DEFAULT_CENTER, DEFAULT_ZOOM, SCALE, TILES} = window.SETTINGS.map.maplibreConfig;#}
{##}
{#            // Initialisation de la carte#}
{#            const bounds = [BOUNDS[0], BOUNDS[1]];#}
{#            const map = new MaplibreMap(mapId, DEFAULT_CENTER, DEFAULT_ZOOM, bounds);#}
{##}
{#            // Stocker l'instance sur l'élément DOM pour réutilisation#}
{#            const mapElement = document.getElementById(mapId);#}
{#            if (mapElement) {#}
{#                mapElement._maplibreMap = map;#}
{#            }#}
{##}
{#                        if (typeof style !== "function") {#}
{#                    style = { ...style };  // créer une copie propre#}
{#                }#}
{##}
{#                console.log('Style utilisé pour la carte:', style);#}
{##}
{#                let detailStyle = window.SETTINGS.map.styles.detail;#}
{#                if(typeof detailStyle !== "function") {#}
{#                    detailStyle = { ...detailStyle };#}
{#                }#}
{##}
{#                console.log('Style de détail utilisé pour la carte:', detailStyle);#}
{##}
{#                // Créer une instance de MaplibreObjectsLayer#}
{#                const objectsLayer = new MaplibreObjectsLayer(null, {#}
{#                    style: style,#}
{#                    detailStyle: detailStyle#}
{#                });#}
{##}
{#                console.log('objectsLayer créé pour le modèle:', objectsLayer);#}
{##}
{#                // Initialiser la couche d'objets#}
{#                objectsLayer.initialize(map.getMap());#}
{##}
{#                // Ajouter une couche de fond OSM#}
{#                TILES.forEach((tile) => {#}
{#                    const [tileName, tileUrl, tileAttribution] = tile;#}
{#                    objectsLayer.addBaseLayer(tileName, {#}
{#                        id: tileName + '-base',#}
{#                        tiles: [tileUrl],#}
{#                        attribution: tileAttribution#}
{#                    });#}
{#                });#}
{##}
{#                // Créer le contrôle de couches#}
{#                map.getMap().addControl(new MaplibreLayerControl(objectsLayer), 'top-right');#}
{##}
{#                // metriques de la carte#}
{#                const unit = SCALE || 'metric';#}
{#                const scale = new maplibregl.ScaleControl({#}
{#                    maxWidth: 80,#}
{#                    unit: unit#}
{#                });#}
{#                map.getMap().addControl(scale, 'bottom-left');#}
{##}
{##}
{#                // Ajouter un contrôle pour réinitialiser la vue#}
{#                map.getMap().addControl(new MaplibreResetViewControl(bounds), 'top-left');#}
{##}
{#            // Attendre que la carte soit chargée avant d'initialiser le callback#}
            {#map.getMap().on('load', function() {#}
            {#    {{ id_map_callback }}(map);#}
            {# }); #}
{#        });#}
{#    {% endif %}#}

    // Initialisation d'une nouvelle carte MapLibre
        document.addEventListener('DOMContentLoaded', function() {
            const mapId = '{{ id_map }}';

            const {BOUNDS, DEFAULT_CENTER, DEFAULT_ZOOM, SCALE, TILES} = window.SETTINGS.map.maplibreConfig;

            // Initialisation de la carte
            const bounds = [BOUNDS[0], BOUNDS[1]];
            const map = new MaplibreMap(mapId, DEFAULT_CENTER, DEFAULT_ZOOM, bounds);

            // Stocker l'instance sur l'élément DOM pour réutilisation
            const mapElement = document.getElementById(mapId);
            if (mapElement) {
                mapElement._maplibreMap = map;
            }
             // Récupérer le style défini dans les settings (ou fallback)
            let style = window.SETTINGS.map.styles.others;
            if (typeof style !== "function") {
                    style = { ...style };  // créer une copie propre
                }

                console.log('Style utilisé pour la carte:', style);

                let detailStyle = window.SETTINGS.map.styles.detail;
                if(typeof detailStyle !== "function") {
                    detailStyle = { ...detailStyle };
                }

                console.log('Style de détail utilisé pour la carte:', detailStyle);

                // Créer une instance de MaplibreObjectsLayer
                const objectsLayer = new MaplibreObjectsLayer(null, {
                    style: style,
                    detailStyle: detailStyle
                });

                console.log('objectsLayer créé pour le modèle:', objectsLayer);

                // Initialiser la couche d'objets
                objectsLayer.initialize(map.getMap());

                // Ajouter une couche de fond OSM
                TILES.forEach((tile) => {
                    const [tileName, tileUrl, tileAttribution] = tile;
                    objectsLayer.addBaseLayer(tileName, {
                        id: tileName + '-base',
                        tiles: [tileUrl],
                        attribution: tileAttribution
                    });
                });

                // Créer le contrôle de couches
                map.getMap().addControl(new MaplibreLayerControl(objectsLayer), 'top-right');

                // metriques de la carte
                const unit = SCALE || 'metric';
                const scale = new maplibregl.ScaleControl({
                    maxWidth: 80,
                    unit: unit
                });
                map.getMap().addControl(scale, 'bottom-left');


                // Ajouter un contrôle pour réinitialiser la vue
                map.getMap().addControl(new MaplibreResetViewControl(bounds), 'top-left');

        });
</script>

{% if display_raw %}<p>Geometry:</p>{% endif %}
<textarea id="{{ id }}" class="required" cols="150" rows="10" name="{{ name }}">{{ serialized }}</textarea>